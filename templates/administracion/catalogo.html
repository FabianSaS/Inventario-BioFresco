{% extends 'base.html' %}
{% block titulo %} Catálogo de Productos {% endblock %}

{% block contenido %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 fw-bold" style="color: #1a1a1a;">Catálogo de Productos</h2>
    <div>
        <a href="{% url 'gestionar_productos' %}" class="btn btn-primary shadow-sm text-dark fw-bold" style="background-color: #aec90b; border: none;">
            <i class="bi bi-plus-circle-fill me-1"></i> Nuevo Producto
        </a>
    </div>
</div>

<div class="card mb-4 shadow-sm border-0">
    <div class="card-body py-3">
        <form method="get" class="d-flex">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input class="form-control border-start-0 ps-0" type="search" name="buscar" placeholder="Buscar por nombre, código SKU..." value="{{ request.GET.buscar|default:'' }}">
                <button class="btn btn-dark" type="submit">Buscar</button>
            </div>
            
            {% if request.GET.buscar %}
                <a href="{% url 'catalogo' %}" class="btn btn-outline-secondary ms-2" title="Limpiar filtro">
                    <i class="bi bi-x-lg"></i>
                </a>
            {% endif %}
        </form>
    </div>
</div>

<div class="card shadow-sm border-0 overflow-hidden">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="ps-4">Cód SKU</th>
                        <th>Nombre del Producto</th>
                        <th>Precio Venta</th>
                        <th>Stock Actual</th>
                        <th>Próx. Vencimiento</th>
                        <th class="text-end pe-4">Acciones Operativas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                    <tr>
                        <td class="ps-4 fw-bold font-monospace">{{ p.codigo }}</td>
                        
                        <td>
                            <span class="fw-medium">{{ p.nombre }}</span>
                            {% if p.tipo_origen == 'PROPIO' %}
                                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;">Propio</span>
                            {% endif %}
                            
                            {% if not p.gestiona_lotes %}
                                <span class="badge bg-info text-dark ms-1" style="font-size: 0.7em;">
                                    <i class="bi bi-lightning-fill"></i> Rápido
                                </span>
                            {% endif %}
                        </td>
                        
                        <td class="text-success fw-bold">${{ p.precio_venta }}</td>
                        
                        <td>
                            {% if p.stock_actual <= p.stock_minimo %}
                                <span class="badge bg-danger rounded-pill px-3">
                                    {{ p.stock_actual }} <i class="bi bi-exclamation-circle"></i>
                                </span>
                            {% else %}
                                <span class="badge bg-success rounded-pill px-3">
                                    {{ p.stock_actual }}
                                </span>
                            {% endif %}
                            <small class="text-muted ms-1">{{ p.get_unidad_medida_display }}</small>
                        </td>

                        <td>
                            {% if p.proximo_vencimiento %}
                                <span class="badge border border-secondary text-dark bg-light">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    {{ p.proximo_vencimiento|date:"d/m/Y" }}
                                </span>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        
                        <td class="text-end pe-4">
                            <div class="d-flex gap-1 justify-content-end">
                                <div class="btn-group shadow-sm">
                                    <a href="{% url 'editar_producto' p.pk %}" class="btn btn-sm btn-light border" title="Editar ficha">
                                        <i class="bi bi-pencil-fill text-secondary"></i>
                                    </a>
                                    <a href="{% url 'eliminar_producto' p.pk %}" class="btn btn-sm btn-light border" title="Eliminar">
                                        <i class="bi bi-trash-fill text-danger"></i>
                                    </a>
                                </div>
                                
                                <div class="vr mx-2 text-muted opacity-25"></div>

                                <a href="{% url 'registrar_movimiento' %}?codigo={{ p.codigo }}&accion=ENTRADA" class="btn btn-sm btn-success shadow-sm" title="Entrada">
                                    <i class="bi bi-plus-lg"></i>
                                </a>

                                <a href="{% url 'registrar_movimiento' %}?codigo={{ p.codigo }}&accion=VENTA" class="btn btn-sm btn-info text-white shadow-sm" title="Venta">
                                    <i class="bi bi-currency-dollar"></i>
                                </a>

                                <a href="{% url 'registrar_movimiento' %}?codigo={{ p.codigo }}&accion=MERMA" class="btn btn-sm btn-warning text-dark shadow-sm" title="Merma">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted bg-light">
                            <i class="bi bi-box-seam display-4 d-block mb-3 opacity-50"></i>
                            No se encontraron productos en el catálogo.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}